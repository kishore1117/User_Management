<div class="container">
    <p-tabs value="0">
        <p-tablist>
            <p-tab value="0">Lookup</p-tab>
            <p-tab value="1">Users</p-tab>
            <p-tab value="2">Upload</p-tab>
        </p-tablist>
        <p-tabpanels>
            <p-tabpanel value="0">
                <div class="admin-header">
                    <div class="admin-left">
                        <h2>Lookup / Admin Management</h2>
                        <p class="subtitle">Manage lookup tables and their records</p>
                    </div>

                    <div class="admin-controls">
                        <label for="tableSelect" class="form-label">Select Table</label>
                        <select id="tableSelect" [(ngModel)]="selectedTable"
                            (change)="onLookupTableSelect(tableSelect.value)" #tableSelect class="p-inputtext">
                            <option value="">-- Select table --</option>
                            <option *ngFor="let t of tableList" [value]="t.value">{{ t.label }}</option>
                        </select>
                        <button pButton type="button" (click)="setActiveSection('lookup'); openLookupAdd()"
                            label="Add New" class="btn btn-primary" [disabled]="!selectedTable"></button>
                        <button pButton type="button" (click)="setActiveSection('lookup')" label="Open Lookup"
                            class="btn btn-ghost"></button>
                    </div>
                </div>
                <!-- PANEL: Lookup -->
                <section *ngIf="!activeSection === null || activeSection === 'lookup'">
                    <div class="panel-title">
                        <h3>Lookup: {{ selectedTable || '—' }}</h3>
                        <small *ngIf="activeSection !== 'lookup'">(disabled)</small>
                    </div>

                    <!-- Existing list -->
                    <div class="data-table-wrap card">
                        <div class="page-header">
                            <div>
                                <strong>{{ tableColumns.length }} columns</strong>
                                <span class="muted"> • </span>
                                <strong>{{ tableData.length }}</strong> records
                            </div>

                            <div class="controls">
                                <input pInputText placeholder="Search..." [(ngModel)]="tableSearch" class="p-inputtext"
                                    [disabled]="activeSection !== 'lookup'" />
                                <button pButton type="button" label="Reload" (click)="loadLookupForSelectedTable()"
                                    [disabled]="activeSection !== 'lookup'"></button>
                            </div>
                        </div>

                        <div *ngIf="tableData?.length; else emptyLookup">
                            <table class="p-table p-component">
                                <thead>
                                    <tr>
                                        <th *ngFor="let col of tableColumns">{{ col.name | titlecase }}</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let row of tableData | slice:0:100">
                                        <td *ngFor="let col of tableColumns">{{ row[col.name] }}</td>
                                        <td>
                                            <button pButton type="button" icon="pi pi-pencil" class="p-button-text"
                                                (click)="openLookupEdit(row)"
                                                [disabled]="activeSection !== 'lookup'"></button>
                                            <button pButton type="button" icon="pi pi-trash"
                                                class="p-button-text p-button-danger" (click)="deleteLookup(row)"
                                                [disabled]="activeSection !== 'lookup'"></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <ng-template #emptyLookup>
                            <div class="p-4">
                                <p>No records found for this table.</p>
                            </div>
                        </ng-template>
                    </div>

                    <!-- Add / Edit form -->
                    <div id="lookup-form" class="form-panel" [class.form-disabled]="activeSection !== 'lookup'">
                        <h4>{{ lookupEditing ? 'Edit' : 'Add' }} {{ selectedTable }}</h4>
                        <form [formGroup]="lookupForm" (ngSubmit)="submitLookup()">
                            <div class="form-grid">
                                <div *ngFor="let col of tableColumns" class="form-group">
                                    <label>{{ col.name | titlecase }}</label>
                                    <ng-container [ngSwitch]="(col.type || 'text')">
                                        <input *ngSwitchCase="'integer'" pInputText type="number"
                                            [formControlName]="col.name"
                                            [disabled]="activeSection !== 'lookup' || (col.name === lookupPrimaryKey)" />
                                        <input *ngSwitchCase="'text'" pInputText [formControlName]="col.name"
                                            [disabled]="activeSection !== 'lookup'" />
                                        <input *ngSwitchDefault pInputText [formControlName]="col.name"
                                            [disabled]="activeSection !== 'lookup'" />
                                    </ng-container>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button pButton type="submit" class="btn btn-primary"
                                    [disabled]="activeSection !== 'lookup' || lookupForm.invalid">{{ lookupEditing ?
                                    'Update' :
                                    'Create' }}</button>
                                <button pButton type="button" class="btn btn-ghost" label="Cancel"
                                    (click)="openLookupAdd()" [disabled]="activeSection !== 'lookup'"></button>
                            </div>
                        </form>
                    </div>
                </section>
            </p-tabpanel>
            <p-tabpanel value="1">
                <!-- User header -->
                <div class="user-header">
                    <div class="user-left">
                        <h2>User Management</h2>
                        <p class="subtitle">Manage system users inline</p>
                    </div>
                    <div class="admin-controls">
                        <button pButton type="button" (click)="setActiveSection('users')" icon="pi pi-users"
                            label="View Users" class="btn btn-ghost"></button>
                        <button pButton type="button" (click)="setActiveSection('users'); openUserAddInline()"
                            label="Add User" class="btn btn-primary"></button>
                    </div>
                </div>
                <!-- PANEL: Users -->
                <section *ngIf="!activeSection === null || activeSection === 'users'">
                    <div class="panel-title">
                        <h3>Users</h3>
                        <small *ngIf="activeSection !== 'users'"> (disabled)</small>
                    </div>

                    <div class="data-table-wrap card">
                        <div class="page-header">
                            <div>
                                <strong>Users</strong>
                                <span class="muted"> • </span>
                                <strong>{{ users.length }}</strong>
                            </div>
                            <div class="controls">
                                <input pInputText placeholder="Search users..." [(ngModel)]="userSearch"
                                    class="p-inputtext" [disabled]="activeSection !== 'users'" />
                                <button pButton type="button" label="Reload" (click)="loadUserSection()"
                                    [disabled]="activeSection !== 'users'"></button>
                                <button pButton type="button" label="Add Inline" (click)="openUserAddInline()"
                                    [disabled]="activeSection !== 'users'"></button>
                            </div>
                        </div>
                        <div *ngIf="this.userColumns.length; else emptyUsers">
                            <table class="p-table p-component">
                                <thead>
                                    <tr>
                                        <td *ngFor="let col of userColumns">{{ col.name | titlecase }}</td>
                                        <td>Actions</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let row of users | slice:0:200">
                                        <td *ngFor="let col of userColumns">{{ row[col.name] }}</td>
                                        <td>
                                            <button pButton type="button" icon="pi pi-eye" class="p-button-text"
                                                (click)="viewUser(row.id)"></button>
                                            <button pButton type="button" icon="pi pi-pencil" class="p-button-text"
                                                (click)="openUserEditInline(row)"
                                                [disabled]="activeSection !== 'users'"></button>
                                            <button pButton type="button" icon="pi pi-trash"
                                                class="p-button-text p-button-danger" (click)="deleteUserInline(row)"
                                                [disabled]="activeSection !== 'users'"></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                        </div>
                        <ng-template #emptyUsers>
                            <div class="p-4">
                                <p>No users found.</p>
                            </div>
                        </ng-template>

                    </div>

                    <!-- Inline user form -->
                    <div id="user-inline-form" class="form-panel" [class.form-disabled]="activeSection !== 'users'">
                        <h4>{{ editingUser ? 'Edit User' : 'Add User' }}</h4>
                        <form [formGroup]="userForm" (ngSubmit)="submitUserInline()">
                            <div class="form-grid">
                                <ng-container *ngFor="let col of userColumns">
                                    <div class="form-group"
                                        *ngIf="!(col.name === 'id' || col.name === 'created_at' || col.name === 'updated_at')">
                                        <label>{{ col.name | titlecase }}</label>
                                        <ng-container [ngSwitch]="(col.type || 'text')">
                                            <input *ngSwitchCase="'integer'" pInputText type="number"
                                                [formControlName]="col.name" [disabled]="activeSection !== 'users'" />
                                            <input *ngSwitchCase="'text'" pInputText [formControlName]="col.name"
                                                [disabled]="activeSection !== 'users'" />
                                            <input *ngSwitchDefault pInputText [formControlName]="col.name"
                                                [disabled]="activeSection !== 'users'" />
                                        </ng-container>
                                    </div>
                                </ng-container>
                            </div>

                            <div class="form-actions">
                                <button pButton type="submit" class="btn btn-primary"
                                    [disabled]="activeSection !== 'users' || userForm.invalid">{{ editingUser ? 'Update
                                    User' :
                                    'Create User' }}</button>
                                <button pButton type="button" class="btn btn-ghost" label="Cancel"
                                    (click)="userFormVisible=false" [disabled]="activeSection !== 'users'"></button>
                            </div>
                        </form>
                    </div>
                </section>
            </p-tabpanel>
            <p-tabpanel value="2">
                <h3>Reports</h3>
                <p>Reports section coming soon...</p>
            </p-tabpanel>

        </p-tabpanels>
    </p-tabs>
    <p *ngIf="loading"> Loading...
        <!-- <p-progressSpinner></p-progressSpinner> -->
    </p>
</div>